<div><style type="text/css">[data-name=xaxis]{font-size:.8em}[data-name=yaxis]{font-size:.8em}.pdl-layout>div[data-type=layout]{display:grid;grid-template-columns:fit-content(2em) 1fr fit-content(10em);grid-template-rows:1fr fit-content(1em);padding:0 .5em}.pdl-layout>div[data-type=layout]>.pdl-cell[data-name=legend]{grid-column:3;grid-row:1/span 2;padding-left:1em}.pdl-layout.legend-bottom>div[data-type=layout]{grid-template-columns:2em 1fr;grid-template-rows:1fr fit-content(2em) fit-content(3em)}.pdl-layout.legend-bottom>div[data-type=layout] .pdl-cell[data-name=legend]{padding-top:1em;grid-column:1/span 2;grid-row:3}</style><script type="@plotdb/block">var formatZhBigInt;formatZhBigInt=function(e){var a,l,r,t,i,u,f,n;if(!Number.isFinite(e)){return String(e)}a=e<0?"-":"";l=Math.floor(Math.abs(e));if(l===0){return"0"}r=[{value:1e12,label:"兆"},{value:1e8,label:"億"},{value:1e4,label:"萬"}];t="";for(i=0,u=r.length;i<u;++i){f=r[i];if(l>=f.value){n=Math.floor(l/f.value);l=l%f.value;t+=n+""+f.label}}if(l>0){t+=l}return a+t};var mod;module.exports={pkg:{name:"bar",version:"0.0.1",extend:{name:"@makechart/base"},dependencies:[],i18n:{"zh-TW":{size:"長度"}}},init:function(t){var e,i,n,r;e=t.root,i=t.context,n=t.t,r=t.pubsub;return r.fire("init",{mod:mod({context:i,t:n})})}};mod=function(t){var e,i,n,S,r,s;e=t.context,i=t.t;n=e.chart,S=e.d3,r=e.debounce;return{sample:function(){var r;r=["apple","banana","peach","orange"];return{raw:[0,1,2,3,4,5,6,7,8,9,10].map(function(t){var e,i,n;e={name:"Y"+(1995+t)};for(i=0;i<=3;++i){n=i;e[r[n]]=(10*Math.random()).toFixed(1)}return e}),binding:{size:[0,1,2,3].map(function(t){return{key:r[t],unit:"KG"}}),name:{key:"name"}}}},config:(s=import$({legend:import$({},n.utils.config.preset.legend),xaxis:JSON.parse(JSON.stringify(n.utils.config.preset.axis)),yaxis:JSON.parse(JSON.stringify(n.utils.config.preset.axis))},n.utils.config.preset["default"]),s.sort={enabled:{type:"boolean",default:false},dir:{type:"choice",values:["asc","desc"],default:"asc"},dimension:{type:"choice",values:["name","size"],default:"size"}},s.type={type:"choice",values:["bar","column"],default:"column"},s.brush={enabled:{type:"boolean",default:true}},s.multiple={type:"choice",values:["stack","group"],default:"stack"},s.percent={type:"boolean",default:false},s.dancing={type:"boolean",default:true},s.gap={type:"number",default:2,min:0,max:100,step:1},s),dimension:{size:{type:"R",multiple:true,name:"size"},name:{type:"NCO",name:"name"}},init:function(){var e,i,t,h=this;this.tint=e=new n.utils.tint;this.svg.addEventListener("click",function(t){var e,i;e=t.target;while(e!==h.svg){if(!e){return}if(!(e.classList&&e.classList.contains("pdl-cell"))){e=e.parentNode;continue}if(e.getAttribute("data-name")==="view"){break}else{return}}if(!h.cfg.dancing||h.cfg.percent){return}i=h.alignIdx||0;for(;;){h.alignIdx=((h.alignIdx||0)+1)%(h.binding.size.length+1);if(h.legend.isSelected(h.alignIdx)||h.alignIdx===i){break}}h.resize();return h.render()});this.g=Object.fromEntries(["view","xaxis","yaxis","legend"].map(function(t){return[t,S.select(h.layout.getGroup(t))]}));this.g.subview=this.g.view.append("g");this.g.brush=this.g.view.append("g");this.brushs={x:S.brushX(),y:S.brushY()};this.brushType=function(){if(h.cfg.type==="bar"){return"y"}else{return"x"}};this.range="null";i=r(150,function(t){var n,e,r,s,i,a;if(!h.cfg.brush.enabled){return}n=t.selection;if((e=JSON.stringify(n))===h.range){return}else{h.range=e}if(!n){return h.filter({name:undefined},true)}else{r=h.scale[h.brushType()].domain();s=h.scale[h.brushType()].bandwidth();if(h.brushType()==="x"){n=n.map(function(t){var e,i,n;return(e=(n=Math.floor(t/s))>0?n:0)<(i=r.length-1)?e:i});i=function(){var t,e,i=[];for(t=n[0],e=n[1];t<=e;++t){i.push(t)}return i}().map(function(t){return r[t]})}else{a=h.layout.getBox("view");n=n.map(function(t){var e,i,n;return(e=(n=Math.floor((a.height-t)/s))>0?n:0)<(i=r.length-1)?e:i});i=function(){var t,e,i=[];for(t=n[1],e=n[0];t<=e;++t){i.push(t)}return i}().map(function(t){return r[t]})}return h.filter({name:{type:"index",value:i}},true)}});this.brushs.x.on("end",function(t){if(h.brushType()==="x"){return i(t)}});this.brushs.x.on("brush",function(t){if(h.brushType()==="x"){return i(t)}});this.brushs.y.on("end",function(t){if(h.brushType()==="y"){return i(t)}});this.brushs.y.on("brush",function(t){if(h.brushType()==="y"){return i(t)}});this.scale=t={};this.yaxis=new n.utils.axis({layout:this.layout,name:"yaxis",direction:"left"});this.xaxis=new n.utils.axis({layout:this.layout,name:"xaxis",direction:"bottom"});this.legend=new n.utils.legend({layout:this.layout,name:"legend",root:this.root,shape:function(t){return S.select(this).attr("fill",e.get(t.text||t.key))}});this.legend.on("select",function(){h.bind();h.resize();return h.render()});return this.tip=new n.utils.tip({root:this.root,accessor:function(t){var e,i,n,r,s,a,u;e=t.evt;if(!(e.target&&(i=S.select(e.target).datum()))){return null}if((n=i.type)==="overlay"||n==="selection"||n==="s"){return}r=isNaN(i.size)?"-":(s=((n=h.cfg)!=null?(a=n[h.type==="column"?"yaxis":"xaxis"])!=null?(u=a.label)!=null?u.format:void 8:void 8:void 8)||".2s",s=S.format(",d"),console.log("~>",i.size,i.rawsize),S.format(s)(i.rawsize)+""+(i.unit||""));return{name:i.name||"",group:i.group||"",value:r}},range:function(){return h.layout.getNode("view").getBoundingClientRect()}})},destroy:function(){if(this.tip){return this.tip.destroy()}},filter:function(t,e){var i=this;e==null&&(e=false);this.render();if(e){return}return this.brush.move(this.g.view,t.name?t.name.map(function(t){return i.scale[i.brushType()](t)}):null)},parse:function(){this.data.map(function(t){return t.size=t.size.map(function(t){if(isNaN(t)){return 0}else{return t}})});return this.alignIdx=undefined},resize:function(){var i,r,t,e,n,s,a,u,h,l,o,c,f,d,g,m,p=this;this.root.querySelector(".pdl-layout").classList.toggle("legend-bottom",this.cfg.legend.position==="bottom");this.type=this.cfg.type||"column";this.brush=this.brushs[this.brushType()];this.legend.config(this.cfg.legend);this.legend.data(function(){var t,e=[];for(t=this.binding.size.length-1;t>=0;--t){i=t;e.push({key:i,text:this.binding.size[i].name||this.binding.size[i].key})}return e}.call(this));this.layout.update(false);this.maxPerGroup=this.binding.size.filter(function(t,e){return p.legend.isSelected(e)}).map(function(t,e){return Math.max.apply(Math,p.data.map(function(t){return t.size[e]}))});if(this.cfg.alignIdx&&!this.alignIdx){this.alignIdx=this.cfg.alignIdx}r=(t=this.cfg.percent?0:this.alignIdx||0)<(e=this.binding.size.length)?t:e;this.baseOffset=this.data.map(function(i){return function(){var t,e,i=[];for(t=0,e=r;t<e;++t){i.push(t)}return i}().reduce(function(t,e){return t+(!p.legend.isSelected(e)?0:i.size[e])},0)||[0]});this.delta=n=Math.max.apply(Math,this.baseOffset);if(this.cfg.multiple==="stack"){if(this.cfg.percent){s=1}else{s=Math.max.apply(Math,this.data.map(function(n){return function(){var t,e,i=[];for(t=r,e=n.size.length;t<e;++t){i.push(t)}return i}().reduce(function(t,e){return t+(!p.legend.isSelected(e)?0:n.size[e])},0)}))+(n||0)}}else if(this.cfg.multiple==="group"){s=Math.max.apply(Math,this.data.map(function(t){return Math.max.apply(Math,t.size.filter(function(t,e){return p.legend.isSelected(e)}))}))}else if(this.cfg.multiple==="split"){s=this.maxPerGroup.reduce(function(t,e){return t+e},0)}this.order=this.data.map(function(t,e){return{key:t._idx,idx:e,name:t.name}});this.data.map(function(t,e){return t.sum=t.size.filter(function(t,e){return p.legend.isSelected(e)}).reduce(function(t,e){return t+e},0)});if(((t=this.cfg).sort||(t.sort={})).enabled){this.order.sort(function(t,e){var i,n,r,s,a;i=p.cfg.sort.dimension==="size"?p.data[t.idx].sum-p.data[e.idx].sum:(n=p.data[t.idx].name,r=p.data[e.idx].name,n=isNaN(+n)?n:+n,r=isNaN(+r)?r:+r,n>r?1:n<r?-1:0);return(!(s=p.cfg.sort.dir==="asc")!==!(a=p.cfg.type==="bar")&&(s||a)?1:-1)*i})}if(this.cfg.palette){this.tint.set(this.cfg.palette)}this.layout.update(false);a=this.layout.getBox("view");if(this.type==="column"){t=this.scale;t.y=S.scaleLinear().domain([0,s]).range([a.height,0]);t.x=S.scaleBand().domain(this.order.map(function(t){return t.name||t.key})).range([0,a.width]);u=(t=Math.ceil(this.layout.getBox("yaxis").height/40))>2?t:2;h=this.cfg.bump?function(){var t,e,i,n=[];for(t=1,e=(i=this.parsed.length||1)>1?i:1;t<=e;++t){n.push(t)}return n}.call(this):this.scale.y.ticks((t=((e=this.cfg).yaxis||(e.yaxis={})).tick.count||4)<u?t:u);this.yaxis.config(this.cfg.yaxis);l=this.binding.size[0]||{};if(this.binding.size.length>1){this.yaxis.caption(l.unit?l.unit+"":"")}else{this.yaxis.caption((l.name||l.key||"")+(l.unit?"("+l.unit+")":""))}this.yaxis.ticks(h);this.yaxis.scale(this.scale.y);this.xaxis.config(this.cfg.xaxis);this.xaxis.ticks(this.data.map(function(t){return t.name}));this.xaxis.scale(this.scale.x);this.xaxis.caption((o=this.binding.name)?(o.name||o.key||"")+(o.unit?"("+this.binding.name.unit+")":""):"")}else{t=this.scale;t.x=S.scaleLinear().domain([0,s]).range([a.width,0]);t.y=S.scaleBand().domain(this.order.map(function(t){return t.name||t.key})).range([0,a.height]);u=(t=Math.ceil(this.layout.getBox("xaxis").width/80))>2?t:2;c=this.cfg.bump?function(){var t,e,i,n=[];for(t=1,e=(i=this.parsed.length||1)>1?i:1;t<=e;++t){n.push(t)}return n}.call(this):this.scale.x.ticks((t=((e=this.cfg).xaxis||(e.xaxis={})).tick.count||4)<u?t:u);this.xaxis.config(this.cfg.xaxis);l=this.binding.size[0]||{};if(this.binding.size.length>1){this.xaxis.caption(l.unit?l.unit+"":"")}else{this.xaxis.caption((l.name||l.key||"")+(l.unit?"("+l.unit+")":""))}this.xaxis.ticks(c);this.xaxis.scale(this.scale.x);this.yaxis.config(this.cfg.yaxis);this.yaxis.ticks(this.data.map(function(t){return t.name}));this.yaxis.scale(this.scale.y);this.yaxis.caption((o=this.binding.name)?(o.name||o.key||"")+(o.unit?"("+this.binding.name.unit+")":""):"")}this.yaxis.format(formatZhBigInt);this.xaxis.format(formatZhBigInt);for(f=0;f<2;++f){i=f;this.layout.update(false);a=this.layout.getBox("view");t=[a.width,a.height],d=t[0],g=t[1];this.tint.set(this.cfg.palette);m=this.cfg.dotSize||3;this.scale.x.range([0,d-m]);this.scale.y.range([g,m]);this.xaxis.render();this.yaxis.render()}a=this.layout.getBox("view");if(this.brushType()==="x"){return this.brush.extent([[0,1],[a.width,a.height-2]])}else{return this.brush.extent([[1,0],[a.width-2,a.height]])}},render:function(){var m,p,t,x,y,b,v,z,w,k,M,N,e,i,n=this;m=this.binding,p=this.scale,t=this.range,x=this.delta,y=this.baseOffset,b=this.maxPerGroup,v=this.cfg,z=this.tint,w=this.data,k=this.type,M=this.legend;N=this.cfg.gap;N<=(e=(this.type==="column"?p.x.bandwidth():p.y.bandwidth())-1)||(N=e);i=this.g.subview.selectAll("g.bar").data(this.data);i.exit().remove();i.enter().append("g").attr("class","bar").attr("transform",function(t,e){if(n.type==="column"){return"translate("+p.x(t.name)+",0)"}else{return"translate(0,"+p.y(t.name)+")"}});this.g.subview.selectAll("g.bar").transition().duration(350).attr("transform",function(t,e){if(n.type==="column"){return"translate("+p.x(t.name)+",0)"}else{return"translate(0,"+p.y(t.name)+")"}});this.g.subview.selectAll("g.bar").each(function(r,i){var t,n,e,s,a,u,h,l,o,c,f,d,g;t=[[],0],n=t[0],e=t[1];e=x-y[i];s=1;if(v.percent===true){s=(t=r.size.filter(function(t,e){return M.isSelected(e)}).reduce(function(t,e){return t+e},0))>1?t:1}for(a=0,u=r.size.length;a<u;++a){h=a;l=r.size[h];o=h;if(!M.isSelected(o)){continue}n.push(c={rawsize:l,size:l/s,offset:e/s,key:o,group:r.name,name:m.size[o].name||m.size[o].key,unit:m.size[o].unit||"",order:n.length});c._raw=import$({},c);if(v.multiple==="split"){e+=b[h]}else if(v.multiple==="stack"){e+=l}}f=S.select(this).selectAll("rect").data(n,function(t,e){return t.key});f.exit().each(function(t,e){return t._removing=true});f.exit().transition().delay(150).remove();d=f.enter().append("rect");d.attr("class",function(){return"data"});if(k==="column"){d.attr("width",function(t,e){var i;return(i=p.x.bandwidth()-2)>1?i:1})}if(k==="column"){d.attr("y",function(t,e){return p.y(0)})}if(k!=="column"){d.attr("height",function(t,e){var i;return(i=p.y.bandwidth()-2)>1?i:1})}if(k!=="column"){d.attr("x",function(t,e){return p.x(0)})}g=S.select(this).selectAll("rect").transition().duration(350).call(function(t){var e;if(v.multiple!=="group"){return}e=t;if(k==="column"){e.attr("x",function(t,e){return N/2+t.order*(p.x.bandwidth()-N)/n.length})}if(k==="column"){e.attr("width",function(t,e){return(p.x.bandwidth()-N)/n.length})}if(k==="column"){e.attr("y",function(t,e){return Math.round(Math.min(p.y(0),p.y(t.size)))})}if(k!=="column"){e.attr("y",function(t,e){return N/2+t.order*(p.y.bandwidth()-N)/n.length})}if(k!=="column"){e.attr("height",function(t,e){return(p.y.bandwidth()-N)/n.length})}if(k!=="column"){e.attr("x",function(t,e){return Math.round(Math.min(p.x(0),p.x(t.size)))})}return e}).call(function(t){var e;if(v.multiple!=="stack"){return}e=t;if(k==="column"){e.attr("x",N/2)}if(k==="column"){e.attr("width",function(t,e){return p.x.bandwidth()-N})}if(k==="column"){e.attr("y",function(t,e){if(t._removing){return p.y(t.offset+t.size/2)}return Math.round(Math.min(p.y(t.offset),p.y(t.offset+t.size)))})}if(k!=="column"){e.attr("y",N/2)}if(k!=="column"){e.attr("height",function(t,e){return p.y.bandwidth()-N})}if(k!=="column"){e.attr("x",function(t,e){if(t._removing){return p.x(t.offset+t.size/2)}return Math.round(Math.min(p.x(t.offset),p.x(t.offset+t.size)))})}return e});if(k==="column"){g.attr("height",function(t,e){if(t._removing){return 0}else{return Math.round(Math.abs(p.y(0)-p.y(t.size)))}})}else{g.attr("width",function(t,e){if(t._removing){return 0}else{return Math.round(Math.abs(p.x(0)-p.x(t.size)))}})}return g.attr("fill",function(t,e){return z.get(t.name,v.colorVariant?i/w.length-.5:0)}).attr("fill-opacity",function(t,e){var i,n;if(!(m.name&&(i=m.name.filter))){return 1}if(!(n=i.value)){return 1}if(in$(r.name,n)){return 1}else{return.2}})});if(this.cfg.brush.enabled){this.g.brush.style("display","block");this.g.brush.call(this.brush)}else{this.g.brush.style("display","none")}this.g.brush.selectAll("rect.selection").attr("shape-rendering","auto");this.legend.render();this.yaxis.render();return this.xaxis.render()},tick:function(){}}};function import$(t,e){var i={}.hasOwnProperty;for(var n in e)if(i.call(e,n))t[n]=e[n];return t}function in$(t,e){var i=-1,n=e.length>>>0;while(++i<n)if(t===e[i])return true;return false}</script><div plug="layout"><div class="pdl-layout"><div data-type="layout"><div class="pdl-cell" data-name="yaxis">&nbsp;</div><div class="pdl-cell" data-name="view"></div><div class="pdl-cell"></div><div class="pdl-cell" data-name="xaxis">&nbsp;</div><div class="pdl-cell" data-name="legend">&nbsp;</div></div><div data-type="render"></div></div></div></div>